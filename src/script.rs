use std::fmt::Write;

use indoc::{concatdoc, formatdoc};

use crate::{env, path, wrapper};

const SCRIPT_TEMPLATE: &str = concatdoc! {"
    #!/usr/bin/env bash
    # Automatically generated by '", env!("CARGO_PKG_NAME"), "'.
"};

#[derive(Default)]
pub struct WrapperParams<'a> {
    pub args: &'a [String],
    pub env_vars: &'a [env::Variable<'a>],
}

impl<'a> WrapperParams<'a> {
    #[cfg(test)]
    fn with_args(args: &'a [String]) -> Self {
        Self {
            args,
            ..Default::default()
        }
    }

    #[cfg(test)]
    fn with_env_vars(env_vars: &'a [env::Variable<'a>]) -> Self {
        Self {
            env_vars,
            ..Default::default()
        }
    }
}

fn generate_binary_wrapper_content(
    unwrapped_bin_path: &path::Escaped,
    params: &WrapperParams,
) -> anyhow::Result<String> {
    // TODO: allow arg passthrough before wrapper args

    let mut wrapper = String::new();

    // first, add all environment variables to the wrapper
    for env in params.env_vars {
        env.write_bash_line(&mut wrapper)?;
    }

    // now execute the binary with the wrapper arguments

    // compile time sanity check: the escaped path should be escaping the same quote
    // character used in the `write!` call
    const _: () = assert!(path::Escaped::ESCAPE_CHAR == '"');
    write!(wrapper, r#"exec "{}""#, unwrapped_bin_path.escaped)?;

    for arg in params.args {
        write!(wrapper, " {}", arg)?;
    }

    // passthrough all other arguments
    write!(wrapper, r#" "\$@""#)?;

    Ok(wrapper)
}

pub fn generate_binary_wrapper(
    unwrapped_bin_path: &path::Escaped,
    params: &WrapperParams,
) -> anyhow::Result<String> {
    let content = generate_binary_wrapper_content(unwrapped_bin_path, params)?;
    Ok(format!("{SCRIPT_TEMPLATE}{content}"))
}

pub fn generate_wrapper_install(
    paths: &wrapper::GeneratedPaths,
    wrapper_script: &str,
) -> anyhow::Result<String> {
    Ok(formatdoc! { r#"
        {SCRIPT_TEMPLATE}
        mv "{wrapped_path}" "{unwrapped_path}"

        cat << _{program_name}_eof > "{wrapped_path}"
        {wrapper_script}
        _{program_name}_eof

        chmod +x "{wrapped_path}"
        "#,
        wrapped_path = paths.wrapped_path.escaped,
        unwrapped_path = paths.unwrapped_path.escaped,
        program_name = env!("CARGO_PKG_NAME"),
    })
}

#[cfg(test)]
mod tests {
    use super::*;

    mod generate_binary_wrapper {
        use super::*;

        #[test]
        fn no_args() {
            let path = path::Escaped::new("test_bin");
            let result = generate_binary_wrapper_content(&path, &WrapperParams::default()).unwrap();
            assert_eq!(result, r#"exec "test_bin" "\$@""#);
        }

        #[test]
        fn path_with_space() {
            let path = path::Escaped::new("/usr/bin/test bin");
            let result = generate_binary_wrapper_content(&path, &WrapperParams::default()).unwrap();
            assert_eq!(result, r#"exec "/usr/bin/test bin" "\$@""#);
        }

        #[test]
        fn path_with_quote() {
            let path = path::Escaped::new("/usr/bin/\"test\"");
            let result = generate_binary_wrapper_content(&path, &WrapperParams::default()).unwrap();
            assert_eq!(result, r#"exec "/usr/bin/\"test\"" "\$@""#);
        }

        #[test]
        fn with_args() {
            let path = path::Escaped::new("/usr/bin/test_bin");
            let args = &[String::from("--arg1"), String::from("--arg2")];
            let result =
                generate_binary_wrapper_content(&path, &WrapperParams::with_args(args)).unwrap();

            assert_eq!(result, r#"exec "/usr/bin/test_bin" --arg1 --arg2 "\$@""#);
        }

        #[test]
        fn with_env_vars() {
            let path = path::Escaped::new("/usr/bin/test_bin");

            let env_vars = &[
                env::Variable::new("ENV1", "val1"),
                env::Variable::new("ENV2", "val2"),
            ];

            let result =
                generate_binary_wrapper_content(&path, &WrapperParams::with_env_vars(env_vars))
                    .unwrap();

            assert_eq!(
                result,
                formatdoc! { r#"
                    export ENV1="val1"
                    export ENV2="val2"
                    exec "/usr/bin/test_bin" "\$@""#
                }
            );
        }
    }
}
